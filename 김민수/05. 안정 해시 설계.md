## 해시 키 재배치(rehash) 문제

N개의 캐시 서버가 있다고 하자. 이 서버들에 부하를 균등하게 나누는 보편적 방법은 해시 함수를 사용하는 것이다.

```
serverIndex = hash(key) % N (N은 서버의 개수이다)
```

이 방법은 서버 풀의 크기가 고정되어 있을 때, 그리고 데이터 분포가 균등할 때는 잘 작동한다. 하지만 서버가 추가되거나 기존 서버가 삭제되면 문제가 생긴다.  그 결과로 캐시 미스(cache miss)가 발생하게 될 것이다. 안정 해시는 이 문제를 효과적으로 해결하는 기술이다.

## 안정 해시

위키피디아에 따르면 안정 해시는 해시 테이블의 크기가 조정 될 때 평균적으로 오직 k/n개의 키만 재배치하는 해시 기술이다. 여기서 k는 키의 개수이고, n은 슬롯의 개수다. 이와는 달리 대부분의 전통적 해시 테이블 테이블은 슬롯의 수가 바뀌면 거의 대부분 키를 재배치한다.

## 기존 구현법의 두 가지 문제

안정 해시 알고리즘은 MIT에서 처음 제안되었다. 그 기본 절차는 다음과 같다

- 서버와 키를 균등 분포 해시 함수를 사용해 해시 링에 배치한다
- 키의 위치에서 링을 시계 방향으로 탐색하다 만나는 최초의 서버가 키가 저장될 서버다

이 접근법에는 두가지 문제가 있다. 서버가 추가되거나 삭제되는 상황을 감안하면 파티션의 크기를 균등하게 유지하는게 불가능하다는 것이 첫번째 문제다. 두 번째 문제는 키의 균등 분포를 달성하기가 어렵다는 것이다.

이 문제를 해결하기 위해 제안된 기법이 가상 노드(virtual node) 또는 복제(replica)라 불리는 기법이다.

### 가상 노드

가상 노드는 실제 노드 또는 서버를 가리키는 노드로서, 하나의 서버는 링 위에 여러 개의 가상 노드를 가질 수 있다.

## 마치며

이번 장에서는 안정 해시가 왜 필요하며 어떻게 동작하는지를 자세히 살펴보았다. 안정 해시의 이점은 다음과 같다.

- 서버가 추가되거나 삭제될 때 재배치되는 키의 수가 최소화된다
- 데이터가 보다 균등하게 분포하게 되므로 수평적 규모 확장성을 달성하기 쉽다
- 핫스팟 키 문제를 줄인다

안정 해시는 실제로 널리 쓰이는 기술이다. 그 중 유명한 것 몇 가지를 예로 들면 다음과 같다.

- 아마존 다이너모 데이터베이스의 파티셔닝 관련 컴포넌트
- 아파치 카산드라 클러스터에서의 데이터 파티셔닝
- 디스코드 채팅 어플리케이션
- 아카마이 CDN
- 매그레프 네트워크 부하 분산기